name: Update and tag release version

on:
  workflow_dispatch:
    inputs:
      binary-to-release:
        description: Binary to release
        type: choice
        options:
          - ampd
          - ampd-sdk
          - ampd-handlers
          - router
          - gateway
          - multisig
          - multisig-prover
          - rewards
          - service-registry
          - voting-verifier
          - coordinator
          - axelarnet-gateway
          - interchain-token-service
          - its-abi-translator
          - event-verifier
      dry-run:
        description: Dry run
        type: boolean
        default: true

jobs:
  release:
    name: Release ${{ github.event.inputs.binary-to-release }}
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 0
          submodules: recursive
          token: ${{ secrets.INTEROP_CI_ACTION_TOKEN }}
      
      - name: Setup variables for sub-project to release
        id: setup-variables
        shell: bash
        run: |
          binary="${{ github.event.inputs.binary-to-release }}"
          declare -A binaries_data=(
            ["ampd"]="ampd,/\(major\)|\(major-ampd\)/,/\(minor\)|\(minor-ampd\)/,ampd packages"
            ["ampd-sdk"]="ampd-sdk,/\(major\)|\(major-ampd-sdk\)/,/\(minor\)|\(minor-ampd-sdk\)/,packages/ampd-sdk"
            ["ampd-handlers"]="ampd-handlers,/\(major\)|\(major-ampd-handlers\)/,/\(minor\)|\(minor-ampd-handlers\)/,ampd-handlers packages/ampd-sdk"
            ["router"]="router,/\(major\)|\(major-router\)|\(major-contracts\)|\(major-connection-router\)/,/\(minor\)|\(minor-router\)|\(minor-contracts\)|\(minor-connection-router\)/,contracts/router packages"
            ["gateway"]="gateway,/\(major\)|\(major-gateway\)|\(major-contracts\)/,/\(minor\)|\(minor-gateway\)|\(minor-contracts\)/,contracts/gateway packages"
            ["multisig"]="multisig,/\(major\)|\(major-multisig\)|\(major-contracts\)/,/\(minor\)|\(minor-multisig\)|\(minor-contracts\)/,contracts/multisig packages"
            ["multisig-prover"]="multisig-prover,/\(major\)|\(major-multisig-prover\)|\(major-contracts\)/,/\(minor\)|\(minor-multisig-prover\)|\(minor-contracts\)/,contracts/multisig-prover packages"
            ["rewards"]="rewards,/\(major\)|\(major-rewards\)|\(major-contracts\)/,/\(minor\)|\(minor-rewards\)|\(minor-contracts\)/,contracts/rewards packages"
            ["service-registry"]="service-registry,/\(major\)|\(major-service-registry\)|\(major-contracts\)/,/\(minor\)|\(minor-service-registry\)|\(minor-contracts\)/,contracts/service-registry packages"
            ["voting-verifier"]="voting-verifier,/\(major\)|\(major-voting-verifier\)|\(major-contracts\)/,/\(minor\)|\(minor-voting-verifier\)|\(minor-contracts\)/,contracts/voting-verifier packages"
            ["coordinator"]="coordinator,/\(major\)|\(major-coordinator\)|\(major-contracts\)/,/\(minor\)|\(minor-coordinator\)|\(minor-contracts\)/,contracts/coordinator packages"
            ["axelarnet-gateway"]="axelarnet-gateway,/\(major\)|\(major-axelarnet-gateway\)|\(major-contracts\)/,/\(minor\)|\(minor-axelarnet-gateway\)|\(minor-contracts\)/,contracts/axelarnet-gateway packages"
            ["interchain-token-service"]="interchain-token-service,/\(major\)|\(major-interchain-token-service\)|\(major-contracts\)/,/\(minor\)|\(minor-interchain-token-service\)|\(minor-contracts\)/,contracts/interchain-token-service packages"
            ["its-abi-translator"]="its-abi-translator,/\(major\)|\(major-its-abi-translator\)|\(major-contracts\)/,/\(minor\)|\(minor-its-abi-translator\)|\(minor-contracts\)/,contracts/its-abi-translator packages"
            ["event-verifier"]="event-verifier,/\(major\)|\(major-event-verifier\)|\(major-contracts\)/,/\(minor\)|\(minor-event-verifier\)|\(minor-contracts\)/,contracts/event-verifier packages"
          )

          if [[ -n "${binaries_data[$binary]}" ]]; then
              IFS=',' read -r binary_to_release major_pattern minor_pattern change_path <<< "${binaries_data[$binary]}"
              echo "binary-to-release=$binary_to_release" >> "$GITHUB_OUTPUT"
              echo "major-pattern=$major_pattern" >> "$GITHUB_OUTPUT"
              echo "minor-pattern=$minor_pattern" >> "$GITHUB_OUTPUT"
              echo "change-path=$change_path" >> "$GITHUB_OUTPUT"
          else
              echo "Unknown binary to release"
              exit 1
          fi

      - name: Release ${{ github.event.inputs.binary-to-release }}
        id: release
        uses: ./.github/actions/release
        with:
          binary-to-release: ${{ steps.setup-variables.outputs.binary-to-release }}
          dry-run: ${{ github.event.inputs.dry-run }}
          major-pattern: ${{ steps.setup-variables.outputs.major-pattern }}
          minor-pattern: ${{ steps.setup-variables.outputs.minor-pattern }}
          change-path: ${{ steps.setup-variables.outputs.change-path }}
          github_token: ${{ secrets.INTEROP_CI_ACTION_TOKEN }}

      - name: Create individual handler tags for ampd-handlers
        if: ${{ github.event.inputs.binary-to-release == 'ampd-handlers' && github.event.inputs.dry-run == 'false' }}
        shell: bash
        run: |
          version_tag=$(git describe --tags --match "ampd-handlers-v*" --abbrev=0 2>/dev/null || echo "")
          if [ -z "$version_tag" ]; then
            echo "Error: Could not find ampd-handlers version tag"
            exit 1
          fi
          
          version=$(echo "$version_tag" | sed 's/ampd-handlers-v//')
          echo "Found version tag: $version_tag (version: $version)"
          
          if [ -d "ampd-handlers/src/bin" ]; then
            handlers=$(ls -d ampd-handlers/src/bin/*/ 2>/dev/null | xargs -n1 basename)
            echo "Found handlers: $handlers"
            
            commit_sha=$(git rev-parse "$version_tag")
            for handler in $handlers; do
              handler_tag="${handler}-handler-v${version}"
              echo "Creating tag: $handler_tag pointing to commit $commit_sha"
              git config --global user.email "devops@interoplabs.io"
              git config --global user.name "Interop Labs CI"

              if git rev-parse "$handler_tag" >/dev/null 2>&1; then
                echo "Tag $handler_tag already exists, skipping"
              else
                git tag -a "$handler_tag" -m "Release ${handler}-handler ${version}" "$commit_sha"
              fi
            done
            
            git push origin --tags
            echo "Successfully created and pushed individual handler tags"
          else
            echo "No handlers found in ampd-handlers/src/bin/"
            exit 1
          fi
